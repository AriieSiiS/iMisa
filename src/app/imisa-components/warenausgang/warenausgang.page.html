<ion-header>
  <ion-toolbar color="dark" class="ion-color ion-color-dark">
    <ion-buttons slot="secondary">
      <ion-button fill="solid" routerLink="/home" routerDirection="root">
        <ion-icon slot="start" color="primary" name="home"></ion-icon>
        Misa&nbsp;&nbsp;
      </ion-button>
    </ion-buttons>

    <ion-title>Warenausgang</ion-title>

    <ion-buttons slot="primary">
      <ion-button (click)="scanAndParse()" aria-label="Scan">
        <ion-icon name="camera-outline"></ion-icon>
      </ion-button>
      <ion-button routerLink="/warenausgang-history" aria-label="History">
        <ion-icon name="time-outline"></ion-icon>
      </ion-button>
      <ion-button color="primary" (click)="sendMock()" aria-label="Send">
        <ion-icon name="paper-plane-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>

  <!-- Mostrar Lagerort por defecto (si existe) -->
  <ion-toolbar *ngIf="defaultWarehouse !== null">
    <ion-title size="small">
      Standard-Lagerort (Device): {{ defaultWarehouse }}
    </ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <!-- Entrada manual / Scan -->
  <ion-card>
    <ion-card-header>
      <ion-card-title>Code scannen oder manuell eingeben</ion-card-title>
      <ion-card-subtitle>
        Formate:
        <br />- Lagerort#ProcCatCode (z. B. 6#100045) <br />- BoundPCatCode (z.
        B. 105382) → Gruppen-Wizard <br />- Lagerort#BoundPCatCode (z. B.
        6#105382) → Gruppen-Wizard
      </ion-card-subtitle>
    </ion-card-header>
    <ion-card-content>
      <ion-item>
        <ion-label position="stacked">Code</ion-label>
        <ion-input
          [(ngModel)]="manualCode"
          placeholder="z. B. 6#100045 oder 105382"
          autocapitalize="off"
          autocomplete="off"
          autocorrect="off"
          spellcheck="false"
        >
        </ion-input>
      </ion-item>
      <div class="ion-text-right ion-margin-top">
        <ion-button (click)="parseManual()">Übernehmen</ion-button>
        <ion-button
          color="success"
          (click)="addFromParsed(1)"
          [disabled]="!lastParsed"
        >
          Hinzufügen
        </ion-button>
      </div>

      <ion-item>
        <ion-label>
          <h2>Letzter Code (raw)</h2>
          <p>{{ lastRaw || '—' }}</p>
        </ion-label>
      </ion-item>
      <ion-item *ngIf="lastParsed">
        <ion-label>
          <h2>Parsed</h2>
          <p>Lagerort (StoragePlaceID): {{ lastParsed.storagePlaceId }}</p>
          <p>Code: {{ lastParsed.procCatCode }}</p>
        </ion-label>
      </ion-item>
    </ion-card-content>
  </ion-card>

  <!-- DETALLE TIPO COMPRA (clonado visual de item-edit) -->
  <ng-container *ngIf="detailProduct && !groupActive">
    <ion-row>
      <ion-col>
        <label><strong>Bezeichnung:</strong></label>
      </ion-col>
    </ion-row>
    <ion-row>
      <ion-col>
        <label>{{ detailProduct.descinternal }}</label>
      </ion-col>
    </ion-row>

    <ion-row>
      <ion-col>
        <label><strong>Kategorie:</strong></label>
      </ion-col>
    </ion-row>
    <ion-row>
      <ion-col>
        <label
          >{{ detailProduct.boundPCatagoryDescription ||
          detailProduct.boundPCatCode }}</label
        >
      </ion-col>
    </ion-row>

    <ion-row>
      <ion-col>
        <label><strong>Artikel Number:</strong></label>
      </ion-col>
      <ion-col>
        <label>{{ detailProduct.code }}</label>
      </ion-col>
    </ion-row>

    <ion-row>
      <ion-col>
        <label><strong>Suchcode:</strong></label>
      </ion-col>
      <ion-col>
        <label>{{ detailProduct.searchcode || '-' }}</label>
      </ion-col>
    </ion-row>

    <ion-row>
      <ion-col>
        <label><strong>Min. Menge:</strong></label>
      </ion-col>
      <ion-col>
        <label>{{ detailProduct.minqty }}</label>
      </ion-col>
    </ion-row>
    <ion-row>
      <ion-col>
        <label><strong>Max. Menge:</strong></label>
      </ion-col>
      <ion-col>
        <label>{{ detailProduct.maxqty }}</label>
      </ion-col>
    </ion-row>
    <ion-row>
      <ion-col>
        <label><strong>Faktor:</strong></label>
      </ion-col>
      <ion-col>
        <label>{{ detailProduct.factorqty }}</label>
      </ion-col>
    </ion-row>

    <ion-item lines="full">
      <ion-label position="floating"><strong>Menge:</strong></ion-label>
      <ion-input
        [value]="waQty"
        (ionChange)="validateWaQty($event.detail.value)"
        inputmode="decimal"
      >
      </ion-input>
    </ion-item>

    <ion-label *ngIf="detailError">
      <p style="color: red">{{ detailError }}</p>
    </ion-label>

    <ion-item lines="full">
      <ion-label position="floating"
        ><strong>Leistungsdatum:</strong></ion-label
      >
      <ion-input type="date" [(ngModel)]="waDate"></ion-input>
    </ion-item>

    <ion-item lines="none">
      <ion-label>Medizinisch indiziert</ion-label>
      <ion-toggle [(ngModel)]="waMedInd"></ion-toggle>
    </ion-item>

    <ion-row>
      <ion-col>
        <ion-button
          color="primary"
          expand="block"
          (click)="confirmDetailToCart()"
        >
          <ion-icon slot="start" name="cart"></ion-icon>
          Speichern
        </ion-button>
      </ion-col>
      <ion-col size="auto">
        <ion-button
          fill="outline"
          expand="block"
          (click)="detailProduct = null"
        >
          Abbrechen
        </ion-button>
      </ion-col>
    </ion-row>
  </ng-container>

  <!-- WIZARD DE GRUPO -->
  <ion-card *ngIf="groupActive">
    <ion-card-header>
      <ion-card-title>Gruppeneingabe</ion-card-title>
      <ion-card-subtitle
        >Artikel {{ groupIndex + 1 }} / {{ groupProducts.length
        }}</ion-card-subtitle
      >
    </ion-card-header>
    <ion-card-content *ngIf="groupCurrent">
      <ion-item>
        <ion-label>
          <h2>{{ groupCurrent.descinternal }}</h2>
          <p>Code: {{ groupCurrent.code }}</p>
          <p>Kategorie: {{ groupCurrent.boundPCatCode }}</p>
          <p>Standard-Lagerort: {{ groupStoragePlaceId }}</p>
        </ion-label>
      </ion-item>

      <ion-item lines="full" class="ion-margin-top">
        <ion-label position="floating"><strong>Menge</strong></ion-label>
        <ion-input
          [value]="groupQty"
          (ionChange)="validateGroupQty($event.detail.value)"
          inputmode="decimal"
        >
        </ion-input>
      </ion-item>
      <ion-text color="warning" *ngIf="groupError">{{ groupError }}</ion-text>

      <ion-item *ngIf="groupRemainderPending" class="ion-margin-top">
        <ion-label>
          Restmenge zu bestätigen: {{ groupRemainderPending.qty }} (Code: {{
          groupRemainderPending.product.code }})
        </ion-label>
      </ion-item>

      <div class="ion-margin-top" *ngIf="groupRemainderPending">
        <ion-button expand="block" (click)="groupConfirmRemainderByScan()">
          Restmenge via Scan bestätigen
        </ion-button>
        <ion-item class="ion-margin-top">
          <ion-label position="stacked">Code manuell eingeben</ion-label>
          <ion-input
            [(ngModel)]="groupManualConfirmCode"
            inputmode="numeric"
            placeholder="{{ groupRemainderPending.product.code }}"
          >
          </ion-input>
        </ion-item>
        <div class="ion-text-right ion-margin-top">
          <ion-button (click)="groupConfirmRemainderByManual()"
            >Bestätigen</ion-button
          >
        </div>
      </div>

      <div class="ion-text-right ion-margin-top" *ngIf="!groupRemainderPending">
        <ion-button color="success" (click)="groupConfirm()"
          >Confirm</ion-button
        >
        <ion-button fill="outline" (click)="groupSkip()">Skip</ion-button>
      </div>
    </ion-card-content>
  </ion-card>

  <!-- Carrito con descripciones + swipe-to-delete -->
  <ion-list inset="true">
    <ion-item-sliding *ngFor="let ln of lines; let i = index">
      <ion-item
        button
        detail="false"
        (click)="selectLine(i)"
        [color]="selectedIndex === i ? 'light' : undefined"
      >
        <ion-icon slot="start" name="cube-outline" color="primary"></ion-icon>
        <ion-label>
          <h2>
            {{ productDescMap[ln.procCatCode] || ('#' + ln.procCatCode) }}
          </h2>
          <p>Code: {{ ln.procCatCode }} — Lager: {{ ln.storagePlaceId }}</p>
          <p *ngIf="ln.leistungsdatum">
            Leistungsdatum: {{ ln.leistungsdatum }}
          </p>
          <p>
            Medizinisch indiziert: {{ ln.medizinischIndiziert ? 'Ja' : 'Nein' }}
          </p>
        </ion-label>
        <ion-note slot="end">{{ ln.qty }}</ion-note>
        <ion-icon
          slot="end"
          color="primary"
          name="chevron-forward-outline"
        ></ion-icon>
      </ion-item>

      <ion-item-options side="end">
        <ion-item-option color="danger" (click)="deleteLine(i)">
          <ion-icon name="trash" slot="icon-only"></ion-icon>
        </ion-item-option>
      </ion-item-options>
    </ion-item-sliding>

    <ion-item *ngIf="lines.length === 0">
      <ion-label>
        Keine Positionen vorhanden. Scannen oder Code eingeben und
        &ldquo;Hinzufügen&rdquo; drücken.
      </ion-label>
    </ion-item>
  </ion-list>

  <!-- Panel de edición del carrito -->
  <ion-card *ngIf="selectedIndex !== null && lines[selectedIndex] as sel">
    <ion-card-header>
      <ion-card-title>Position bearbeiten</ion-card-title>
      <ion-card-subtitle>
        {{ productDescMap[sel.procCatCode] || ('#' + sel.procCatCode) }}
      </ion-card-subtitle>
    </ion-card-header>
    <ion-card-content>
      <ion-item lines="full">
        <ion-label position="stacked">Menge</ion-label>
        <ion-input
          type="number"
          inputmode="decimal"
          [(ngModel)]="editQty"
        ></ion-input>
      </ion-item>

      <ion-item lines="full">
        <ion-label position="stacked">Leistungsdatum</ion-label>
        <ion-input type="date" [(ngModel)]="editLeistungsdatum"></ion-input>
      </ion-item>

      <ion-item lines="none">
        <ion-label>Medizinisch indiziert</ion-label>
        <ion-toggle [(ngModel)]="editMedIndiziert"></ion-toggle>
      </ion-item>

      <ion-item lines="full" class="ion-margin-top">
        <ion-label position="stacked">Teilmenge für neue Zeile</ion-label>
        <ion-input
          type="number"
          inputmode="decimal"
          [(ngModel)]="splitQty"
          placeholder="z. B. 1"
        >
        </ion-input>
      </ion-item>

      <div class="ion-text-right ion-margin-top">
        <ion-button color="primary" (click)="saveSelected()"
          >Speichern</ion-button
        >
        <ion-button fill="outline" (click)="duplicateSelected()"
          >Duplizieren</ion-button
        >
        <ion-button fill="outline" (click)="splitSelected()">Teilen</ion-button>
        <ion-button color="danger" fill="outline" (click)="deleteSelected()"
          >Löschen</ion-button
        >
      </div>
    </ion-card-content>
  </ion-card>
</ion-content>
