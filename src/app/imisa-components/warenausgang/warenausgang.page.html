<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/home"></ion-back-button>
    </ion-buttons>
    <ion-title>Warenausgang</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="scanAndParse()" aria-label="Scan Warenausgang">
        <ion-icon name="camera-outline"></ion-icon>
      </ion-button>
      <ion-button color="primary" (click)="sendMock()" aria-label="Send Mock">
        <ion-icon name="paper-plane-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
  <!-- NUEVO: mostrar Lagerort por defecto -->
  <ion-toolbar *ngIf="defaultWarehouse !== null">
    <ion-title size="small">
      Standard-Lagerort (Device): {{ defaultWarehouse }}
    </ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <!-- Entrada manual + Añadir -->
  <ion-card>
    <ion-card-header>
      <ion-card-title>Code scannen oder manuell eingeben</ion-card-title>
      <ion-card-subtitle
        >Format: Lagerort#ProcCatCode (z. B. 6#100045)</ion-card-subtitle
      >
    </ion-card-header>
    <ion-card-content>
      <ion-item>
        <ion-label position="stacked">Code</ion-label>
        <ion-input
          [(ngModel)]="manualCode"
          placeholder="z. B. 6#100045"
          autocapitalize="off"
          autocomplete="off"
          autocorrect="off"
          spellcheck="false"
        >
        </ion-input>
      </ion-item>
      <div class="ion-text-right ion-margin-top">
        <ion-button (click)="parseManual()">Übernehmen</ion-button>
        <ion-button
          color="success"
          (click)="addFromParsed(1)"
          [disabled]="!lastParsed"
          >Hinzufügen</ion-button
        >
      </div>

      <ion-item>
        <ion-label>
          <h2>Letzter Code (raw)</h2>
          <p>{{ lastRaw || '—' }}</p>
        </ion-label>
      </ion-item>
      <ion-item *ngIf="lastParsed">
        <ion-label>
          <h2>Parsed</h2>
          <p>Lagerort (StoragePlaceID): {{ lastParsed.storagePlaceId }}</p>
          <p>ProcCatCode: {{ lastParsed.procCatCode }}</p>
        </ion-label>
      </ion-item>
    </ion-card-content>
  </ion-card>

  <!-- Lista de posiciones -->
  <ion-list inset="true">
    <ion-item
      button
      detail="false"
      *ngFor="let ln of lines; let i = index"
      (click)="selectLine(i)"
      [color]="selectedIndex === i ? 'light' : undefined"
    >
      <ion-label>
        <h2>
          ProcCatCode: {{ ln.procCatCode }} | Lager: {{ ln.storagePlaceId }}
        </h2>
        <p>Menge: {{ ln.qty }}</p>
        <p *ngIf="ln.leistungsdatum">Leistungsdatum: {{ ln.leistungsdatum }}</p>
        <p>
          Medizinisch indiziert: {{ ln.medizinischIndiziert ? 'Ja' : 'Nein' }}
        </p>
      </ion-label>
    </ion-item>

    <ion-item *ngIf="lines.length === 0">
      <ion-label
        >Keine Positionen vorhanden. Scannen oder Code eingeben und
        &ldquo;Hinzufügen&rdquo; drücken.</ion-label
      >
    </ion-item>
  </ion-list>

  <!-- Panel de edición -->
  <ion-card *ngIf="selectedIndex !== null && lines[selectedIndex] as sel">
    <ion-card-header>
      <ion-card-title>Position bearbeiten</ion-card-title>
      <ion-card-subtitle
        >ProcCatCode: {{ sel.procCatCode }} | Lager: {{ sel.storagePlaceId
        }}</ion-card-subtitle
      >
    </ion-card-header>
    <ion-card-content>
      <ion-item lines="full">
        <ion-label position="stacked">Menge</ion-label>
        <ion-input
          type="number"
          inputmode="decimal"
          [(ngModel)]="editQty"
        ></ion-input>
      </ion-item>

      <ion-item lines="full">
        <ion-label position="stacked">Leistungsdatum</ion-label>
        <ion-input type="date" [(ngModel)]="editLeistungsdatum"></ion-input>
      </ion-item>

      <ion-item lines="none">
        <ion-label>Medizinisch indiziert</ion-label>
        <ion-toggle [(ngModel)]="editMedIndiziert"></ion-toggle>
      </ion-item>

      <div class="ion-text-right ion-margin-top">
        <ion-button color="primary" (click)="saveSelected()"
          >Speichern</ion-button
        >
        <ion-button fill="outline" (click)="duplicateSelected()"
          >Duplizieren</ion-button
        >
        <ion-button color="danger" fill="outline" (click)="deleteSelected()"
          >Löschen</ion-button
        >
      </div>
    </ion-card-content>
  </ion-card>
</ion-content>
